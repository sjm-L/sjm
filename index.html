<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>FCM ì•Œë¦¼ í…ŒìŠ¤íŠ¸</title>

    <!-- âœ… PWA ê´€ë ¨ ë©”íƒ€ íƒœê·¸ ì¶”ê°€ -->
    <link rel="manifest" href="/manifest.json" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="theme-color" content="#ffffff" />
  </head>
  <body>
    <h1>ğŸ“¢ ì•Œë¦¼ í…ŒìŠ¤íŠ¸</h1>
    <button id="pushBtn">ì•Œë¦¼ ê¶Œí•œ ìš”ì²­</button>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
      import {
        getMessaging,
        getToken,
        onMessage,
      } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-messaging.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDcIGVTaeZOMYO7n6fWIzfyL0JnWYb8atA",
        authDomain: "sjml-18f14.firebaseapp.com",
        projectId: "sjml-18f14",
        storageBucket: "sjml-18f14.firebasestorage.app",
        messagingSenderId: "937757609525",
        appId: "1:937757609525:web:3f8b13a84fe9792b19eb7c",
        measurementId: "G-3LX485Q094",
      };

      const app = initializeApp(firebaseConfig);
      const messaging = getMessaging(app);

      const registerServiceWorkerAndGetToken = async () => {
        try {
          const registration = await navigator.serviceWorker.register(
            "/firebase-messaging-sw.js"
          );
          console.log("âœ… ì„œë¹„ìŠ¤ì›Œì»¤ ë“±ë¡ ì„±ê³µ");

          const permission = await Notification.requestPermission();
          if (permission !== "granted") {
            alert("ğŸ“‹ í˜„ì¬ ê¶Œí•œ ìƒíƒœ: " + permission);
            return;
          }

          const token = await getToken(messaging, {
            vapidKey:
              "BJHlIFtaDRwKqCFrpo8LzNgThJmjkXXZAxuivcvObj6uARpv2RwPksQRq5nzBmVVKLBr_QefRSRRMq7rGdYb1eA",
            serviceWorkerRegistration: registration,
          });

          console.log("âœ… í† í°:", token);
          alert("ğŸ“² í‘¸ì‹œ í† í°:\n" + token);
        } catch (err) {
          console.error("ğŸ’¥ ì˜¤ë¥˜ ë°œìƒ:", err);
          alert("ğŸ’¥ ì˜¤ë¥˜: " + err.message);
        }
      };

      document
        .getElementById("pushBtn")
        .addEventListener("click", registerServiceWorkerAndGetToken);

      // âœ… Foreground ë©”ì‹œì§€ ìˆ˜ì‹ 
      onMessage(messaging, (payload) => {
        console.log("ğŸ“¥ Foreground ë©”ì‹œì§€ ë„ì°©:", payload);
        const { title, body } = payload.notification;

        // í•„ìš”ì‹œ ì•Œë¦¼ ë„ìš°ëŠ” ë¡œì§ ì—¬ê¸°ì— ì¶”ê°€
        if (Notification.permission === "granted") {
          new Notification(title, { body });
        }
      });

      // ğŸ”» [ì¶”ê°€] ì•± ë¡œë“œ ì‹œ ìºì‹œì—ì„œ ë°±ê·¸ë¼ìš´ë“œ ë©”ì‹œì§€ êº¼ë‚´ê¸°
      window.addEventListener("load", async () => {
        try {
          const cache = await caches.open("push-cache");
          const res = await cache.match("/last-message");

          if (res) {
            const payload = await res.json();
            const { title, body } = payload.notification || {
              title: "ì•Œë¦¼",
              body: "ë‚´ìš© ì—†ìŒ",
            };

            // âœ… ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ í‘œì‹œ
            alert(`ğŸ“¬ ì €ì¥ëœ ë©”ì‹œì§€\n\nì œëª©: ${title}\në‚´ìš©: ${body}`);

            // âœ… ì¤‘ë³µ ë°©ì§€ë¥¼ ìœ„í•´ ì‚­ì œ
            await cache.delete("/last-message");
          }
        } catch (err) {
          console.error("ğŸ’¥ ìºì‹œì—ì„œ ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
        }
      });
    </script>
  </body>
</html>
